<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=/piv-agent/docs/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/piv-agent/favicons/favicon.ico><link rel=apple-touch-icon href=/piv-agent/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/piv-agent/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/piv-agent/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/piv-agent/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/piv-agent/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/piv-agent/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/piv-agent/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/piv-agent/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/piv-agent/favicons/android-192x192.png sizes=192x192><title>PIV Agent Documentation | PIV Agent</title>
<meta name=description content="PIV Agent replaces ssh-agent and gpg-agent, and allows you to use your PIV security token with SSH or GPG"><meta property="og:title" content="PIV Agent Documentation"><meta property="og:description" content="PIV Agent replaces ssh-agent and gpg-agent, and allows you to use your PIV security token with SSH or GPG"><meta property="og:type" content="website"><meta property="og:url" content="/piv-agent/docs/"><meta property="og:site_name" content="PIV Agent"><meta itemprop=name content="PIV Agent Documentation"><meta itemprop=description content="PIV Agent replaces ssh-agent and gpg-agent, and allows you to use your PIV security token with SSH or GPG"><meta name=twitter:card content="summary"><meta name=twitter:title content="PIV Agent Documentation"><meta name=twitter:description content="PIV Agent replaces ssh-agent and gpg-agent, and allows you to use your PIV security token with SSH or GPG"><link rel=preload href=/piv-agent/scss/main.min.d4295932a7f32f47494206bb9727760ae46aeca9300490372303433c378862be.css as=style><link href=/piv-agent/scss/main.min.d4295932a7f32f47494206bb9727760ae46aeca9300490372303433c378862be.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/piv-agent/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>PIV Agent</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/piv-agent/offline-search-index.cbdf78cdcea22c7c02f84d4eb2d7d675.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/piv-agent/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>PIV Agent Documentation</h1><ul><li>1: <a href=#pg-64407d3e6d5ef382426bdfbcae040c6a>Install</a></li><li>2: <a href=#pg-85ad37f4d4d62ce0f24ea8a26b95ba09>Setup</a></li><li>3: <a href=#pg-a4b7eec254cc5e87ab47922f32fbc64b>Use</a></li><li>4: <a href=#pg-956da29f025cba37fca9fe6b80ab5d48>FAQ</a></li><li>5: <a href=#pg-671ba55e5fa3b5d9ea81e2f7aab5ef61>GPG Walkthrough</a></li></ul><div class=content><p>PIV Agent must be installed and set up to work with your hardware security device before use.</p></div></div><div class=td-content><h1 id=pg-64407d3e6d5ef382426bdfbcae040c6a>1 - Install</h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=consider-redundancy>Consider redundancy<a class=td-heading-self-link href=#consider-redundancy aria-label="Heading self-link"></a></h3><p>If you lose access to your hardware security device (for example if it is lost, stolen, or broken) <strong>there is no way to recover the keys stored on it</strong>.
For that reason it is highly recommended that you use fallback SSH or GPG keyfiles and/or multiple hardware security devices.</p><h3 id=install-pcsclite>Install pcsclite<a class=td-heading-self-link href=#install-pcsclite aria-label="Heading self-link"></a></h3><p><code>piv-agent</code> has transitive dependencies through <a href=https://github.com/go-piv/piv-go#installation><code>piv-go</code></a>, on <a href=https://pcsclite.apdu.fr/><code>pcsclite</code></a>.</p><pre tabindex=0><code># debian / ubuntu
sudo apt install libpcsclite1
# TODO: other platforms
...
</code></pre><h2 id=install-piv-agent>Install piv-agent<a class=td-heading-self-link href=#install-piv-agent aria-label="Heading self-link"></a></h2><p>Download the latest <a href=https://github.com/smlx/piv-agent/releases>release</a>, and extract it to a temporary location.</p><h3 id=linux>Linux<a class=td-heading-self-link href=#linux aria-label="Heading self-link"></a></h3><p>Copy the <code>piv-agent</code> binary into your <code>$PATH</code>, and the <code>systemd</code> unit files to the correct location:</p><pre tabindex=0><code>sudo cp piv-agent /usr/local/bin/
cp deploy/systemd/piv-agent.{socket,service} ~/.config/systemd/user/
systemctl --user daemon-reload
</code></pre><h3 id=macos>macOS<a class=td-heading-self-link href=#macos aria-label="Heading self-link"></a></h3><p><code>piv-agent</code> requires <a href=https://brew.sh>Homebrew</a> in order to install dependencies.
So install that first.</p><p>Copy the <code>piv-agent</code> binary into your <code>$PATH</code>, and the <code>launchd</code> <code>.plist</code> files to the correct location:</p><pre tabindex=0><code>sudo cp piv-agent /usr/local/bin/
cp deploy/launchd/com.github.smlx.piv-agent.plist ~/Library/LaunchAgents/
</code></pre><p>From what I can tell <code>.plist</code> files only support absolute file paths, even for user agents.
So edit <code>~/Library/LaunchAgents/com.github.smlx.piv-agent.plist</code> and update the path to <code>$HOME/.gnupg/S.gpg-agent</code>.</p><p>If you plan to use <code>gpg</code>, install it via <code>brew install gnupg</code>.
If not, you still need a <code>pinentry</code>, so <code>brew install pinentry</code>.</p><p>If <code>~/.gnupg</code> doesn&rsquo;t already exist, create it.</p><pre tabindex=0><code>mkdir ~/.gnupg
chmod 700 ~/.gnupg
</code></pre><p>Then enable the service:</p><pre tabindex=0><code>launchctl bootstrap gui/$UID ~/Library/LaunchAgents/com.github.smlx.piv-agent.plist
launchctl enable gui/$UID/com.github.smlx.piv-agent
</code></pre><p>A socket should appear in <code>~/.gnupg/S.gpg-agent</code>.</p><p>Disable <code>ssh-agent</code> to avoid <code>SSH_AUTH_SOCK</code> environment variable conflict.</p><pre tabindex=0><code>launchctl disable gui/$UID/com.openssh.ssh-agent
</code></pre><p>Set <code>launchd</code> user path to include <code>/usr/local/bin/</code> for <code>pinentry</code>.</p><pre tabindex=0><code>sudo launchctl config user path $PATH
</code></pre><p>Reboot and log back in.</p><h3 id=socket-activation>Socket activation<a class=td-heading-self-link href=#socket-activation aria-label="Heading self-link"></a></h3><p><code>piv-agent</code> relies on <a href=https://0pointer.de/blog/projects/socket-activated-containers.html>socket activation</a>, and is currently tested with <code>systemd</code> on Linux, and <code>launchd</code> on macOS.
It doesn&rsquo;t listen to any sockets directly, and instead requires the init system to pass file descriptors to the <code>piv-agent</code> process after it is running.
This requirement makes it possible to exit the process when not in use.</p><p><code>ssh-agent</code> and <code>gpg-agent</code> functionality are enabled by default in the <code>systemd</code> and <code>launchd</code> configuration files.</p><p>On Linux, the index of the sockets listed in <code>piv-agent.socket</code> are indicated by the arguments to <code>--agent-types</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-85ad37f4d4d62ce0f24ea8a26b95ba09>2 - Setup</h1><div class=lead>Set up piv-agent to work with your hardware.</div><h2 id=hardware>Hardware<a class=td-heading-self-link href=#hardware aria-label="Heading self-link"></a></h2><h3 id=default-setup>Default setup<a class=td-heading-self-link href=#default-setup aria-label="Heading self-link"></a></h3><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>This procedure resets the state of the PIV applet to factory defaults and wipes any existing keys from <em>all</em> PIV slots.</div><p>This procedure is only required once per hardware security device.
Performing it a second time will reset the keys on the PIV applet of the device.
It will not make any changes to applets providing other functionality the device may have, such as WebAuthn.</p><p>By default, <code>piv-agent</code> uses six slots on your hardware security device to set up three signing keys, and three decrypting key.
Each of the signing and decrypting keys have different <a href=https://docs.yubico.com/yesdk/users-manual/application-piv/pin-touch-policies.html>touch policies</a>: never required, cached (for 15 seconds), and always.</p><p>The three signing keys are used for both SSH and GPG signing.
The decrypting keys are used for GPG decryption.
Having a range of touch policies available facilitates practical use of the hardware security device.</p><p>The default slot usage by <code>piv-agent</code> is detailed in the table below, with reference to the <a href=https://developers.yubico.com/PIV/Introduction/Certificate_slots.html>Yubikey certificate slot usage description</a>.
It is highly recommended to use these setup defaults as this has had the most usability testing.</p><table><thead><tr><th>Slot ID</th><th>Nominal purpose</th><th><code>piv-agent</code> usage</th><th>Touch policy</th></tr></thead><tbody><tr><td><code>0x9a</code></td><td>PIV Authentication</td><td>Signing</td><td>Cached</td></tr><tr><td><code>0x9c</code></td><td>Digital Signature</td><td>Signing</td><td>Always</td></tr><tr><td><code>0x9e</code></td><td>Card Authentication</td><td>Signing</td><td>Never</td></tr><tr><td><code>0x9d</code></td><td>Key Management</td><td>Decrypting</td><td>Cached</td></tr><tr><td><code>0x82</code></td><td>Key Management (retired)</td><td>Decrypting</td><td>Always</td></tr><tr><td><code>0x83</code></td><td>Key Management (retired)</td><td>Decrypting</td><td>Never</td></tr></tbody></table><h4 id=example-setup-workflow>Example setup workflow<a class=td-heading-self-link href=#example-setup-workflow aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># find the name of the hardware security devices (cards)</span>
</span></span><span style=display:flex><span>piv-agent list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># generate new keys (PIN will be requested via interactive prompt)</span>
</span></span><span style=display:flex><span>piv-agent setup --card<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Yubico YubiKey FIDO+CCID 01 00&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># view newly generated keys (SSH only by default)</span>
</span></span><span style=display:flex><span>piv-agent list
</span></span></code></pre></div><h3 id=single-slot-setup>Single slot setup<a class=td-heading-self-link href=#single-slot-setup aria-label="Heading self-link"></a></h3><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4><p><code>piv-agent</code> has been designed to work best with the default setup.
Only set up single slots if you know what you are doing.</p><p>This action can be destructive.
If you reset a slot which already contains a key, that key will be lost.</p></div><p>It is possible to set up a single PIV slot on your hardware device without resetting the PIV applet entirely.
This means that you can target a single slot to set up a key if the slot has not been set up yet, or reset a key if the slot already contains one.
Other PIV slots will not be affected, and will retain their existing keys.</p><p>For example this command will reset just the decrypting key with touch policy <code>never</code> on your Yubikey:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>piv-agent setup-slots --card<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Yubico YubiKey FIDO+CCID 01 00&#34;</span> --pin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>123456</span> --decrypting-keys<span style=color:#ce5c00;font-weight:700>=</span>never --reset-slots
</span></span></code></pre></div><p>See the interactive help for more usage details:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>piv-agent setup-slots --help
</span></span></code></pre></div><h2 id=ssh>SSH<a class=td-heading-self-link href=#ssh aria-label="Heading self-link"></a></h2><h3 id=list-keys>List keys<a class=td-heading-self-link href=#list-keys aria-label="Heading self-link"></a></h3><p>List your hardware SSH keys:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>piv-agent list
</span></span></code></pre></div><p>Add the public SSH key with the touch policy you want from the list, to any SSH service.</p><h3 id=set-ssh_auth_sock>Set <code>SSH_AUTH_SOCK</code><a class=td-heading-self-link href=#set-ssh_auth_sock aria-label="Heading self-link"></a></h3><p>Export the <code>SSH_AUTH_SOCK</code> variable in your shell.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>SSH_AUTH_SOCK</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$XDG_RUNTIME_DIR</span>/piv-agent/ssh.socket
</span></span></code></pre></div><h3 id=list-keys-using-ssh-add>List keys using ssh-add<a class=td-heading-self-link href=#list-keys-using-ssh-add aria-label="Heading self-link"></a></h3><p>Confirm that <code>ssh-add</code> can talk to <code>piv-agent</code> by listing the keys available.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-add -L
</span></span></code></pre></div><p>You should see the Yubikey ssh keys listed.</p><h3 id=prefer-keys-on-the-hardware-security-device>Prefer keys on the hardware security device<a class=td-heading-self-link href=#prefer-keys-on-the-hardware-security-device aria-label="Heading self-link"></a></h3><p>If you don&rsquo;t already have one, it&rsquo;s a good idea to generate an <code>ed25519</code> keyfile and add that to all SSH services too for redundancy.
<code>piv-agent</code> will automatically load and use <code>~/.ssh/id_ed25519</code> as a fallback.</p><p>By default, <code>ssh</code> will offer <a href=https://manpages.debian.org/testing/openssh-client/ssh_config.5.en.html#IdentityFile>keyfiles it finds on disk</a> <em>before</em> those from the agent.
This is a problem because <code>piv-agent</code> is designed to offer keys from the hardware token first, and only fall back to local keyfiles if token keys are refused.</p><p>To get <code>ssh</code> to offer hardware keys first instead, copy the output of the hardware keys you want to offer from the <code>ssh-add -L</code> command to a local file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># list keys</span>
</span></span><span style=display:flex><span>ssh-add -L
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># add output to local file</span>
</span></span><span style=display:flex><span>ssh-add -L <span style=color:#000;font-weight:700>|</span> grep cached &gt; ~/.ssh/id_yk_cached.pub
</span></span></code></pre></div><p>And add a line referencing the file to your <code>ssh_config</code>.</p><pre tabindex=0><code>IdentityFile ~/.ssh/id_yk_cached.pub
</code></pre><h2 id=gpg>GPG<a class=td-heading-self-link href=#gpg aria-label="Heading self-link"></a></h2><h3 id=export-fallback-cryptographic-keys>Export fallback cryptographic keys<a class=td-heading-self-link href=#export-fallback-cryptographic-keys aria-label="Heading self-link"></a></h3><p>Private GPG keys to be used by <code>piv-agent</code> must be exported to the directory <code>~/.gnupg/piv-agent.secring/</code>.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>This step requires <code>gpg-agent</code> to be running, not <code>piv-agent</code>.
See the <a href=/piv-agent/docs/faq/>FAQ</a> for how to switch between the two services.</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>If your private key is encrypted using a password (it should be!), the encryption is retained during export.
The key is still stored encrypted in the exported keyfile - it&rsquo;s just converted into a standard OpenPGP format that <code>piv-agent</code> can read.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># example</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># set umask for user-only permissions</span>
</span></span><span style=display:flex><span><span style=color:#204a87>umask</span> <span style=color:#0000cf;font-weight:700>77</span>
</span></span><span style=display:flex><span>mkdir -p ~/.gnupg/piv-agent.secring
</span></span><span style=display:flex><span>gpg --export-secret-key 0xB346A434C7652C02 &gt; ~/.gnupg/piv-agent.secring/art@example.com.gpg
</span></span></code></pre></div><h3 id=disable-gpg-agent>Disable gpg-agent<a class=td-heading-self-link href=#disable-gpg-agent aria-label="Heading self-link"></a></h3><p>It is not possible to set a custom path for the <code>gpg-agent</code> socket in a similar manner to <code>ssh-agent</code>.
Instead <code>gpg-agent</code> always uses a hard-coded path for its socket.
In order for <code>piv-agent</code> to work with <code>gpg</code>, it sets up a socket in this same default location.
To avoid conflict over this path, <code>gpg-agent</code> should be disabled.</p><p>This is how you can disable <code>gpg-agent</code> on Debian/Ubuntu:</p><ul><li>Add <code>no-autostart</code> to <code>~/.gnupg/gpg.conf</code>.</li><li><code>systemctl --user disable --now gpg-agent.socket gpg-agent.service; pkill gpg-agent</code></li></ul><p>Other platforms may have slightly different instructions - PRs welcome.</p><h3 id=import-public-cryptographic-keys-from-the-security-hardware>Import public cryptographic keys from the security hardware<a class=td-heading-self-link href=#import-public-cryptographic-keys-from-the-security-hardware aria-label="Heading self-link"></a></h3><p>Before any private GPG keys on the hardware dvice can be used, <code>gpg</code> requires their public keys to be imported.
This structure of a GPG public key contains a <a href=https://datatracker.ietf.org/doc/html/rfc4880#section-5.11>User ID packet</a>, which must be signed by the associated <em>private key</em>.</p><p>The <code>piv-agent list</code> command can synthesize a public key for the private key stored on the security hardware device.
Listing a GPG key via <code>piv-agent list --key-formats=gpg</code> will require a touch to perform signing on the keys associated with those slots (due to the User ID packet).
You should provide a name and email which will be embedded in the synthesized public key (see <code>piv-agent --help list</code>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># example</span>
</span></span><span style=display:flex><span>piv-agent list --key-formats<span style=color:#ce5c00;font-weight:700>=</span>ssh,gpg --pgp-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Art Vandelay&#39;</span> --pgp-email<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;art@example.com&#39;</span>
</span></span></code></pre></div><p>Paste the public key(s) you would like to use into a <code>key.asc</code> file, and run <code>gpg --import key.asc</code>.</p><h2 id=gpg-advanced>GPG Advanced<a class=td-heading-self-link href=#gpg-advanced aria-label="Heading self-link"></a></h2><p>If you have followed the setup instructions to this point you should have a functional <code>gpg-agent</code> backed by a PIV hardware device.
The following instructions allow deeper integration of the hardware with existing GPG keys and workflows.</p><h3 id=add-cryptographic-key-stored-in-hardware-as-a-gpg-signing-subkey>Add cryptographic key stored in hardware as a GPG signing subkey<a class=td-heading-self-link href=#add-cryptographic-key-stored-in-hardware-as-a-gpg-signing-subkey aria-label="Heading self-link"></a></h3><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>There is a <a href=https://dev.gnupg.org/T5555>bug</a> in current versions of GnuPG which doesn&rsquo;t allow ECDSA keys to be added as signing subkeys.
This is unfortunate since signing is much more useful than decryption.</p><p>Until this is fixed upstream, <a href=https://github.com/smlx/gnupg-piv-agent>here is a Docker image</a> containing a patched version of <code>gpg</code> which will add ECDSA keys as signing subkeys.</p></div><p>Adding a <code>piv-agent</code> OpenPGP key as a signing subkey of an existing OpenPGP key is a convenient way to integrate a hardware security device with your existing <code>gpg</code> workflow.
This allows you to do things like sign <code>git</code> commits using your Yubikey, while keeping the same OpenPGP key ID.
Adding a subkey requires cross-signing between the master key and sub key, so you need to export the master secret key of your existing OpenPGP key as described above to make it available to <code>piv-agent</code>.</p><p><code>gpg</code> will choose the <em>newest</em> available subkey to perform an action. So it will automatically prefer a newly added <code>piv-agent</code> subkey over any existing keyfile subkeys, but fall back to keyfiles if e.g. the Yubikey is not plugged in.</p><p>See the <a href=/piv-agent/docs/gpg-walkthrough/>GPG Walkthrough</a> for an example of this procedure.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a4b7eec254cc5e87ab47922f32fbc64b>3 - Use</h1><div class=lead>Use piv-agent with ssh and gpg.</div><h2 id=start-piv-agentsocket>Start <code>piv-agent.socket</code><a class=td-heading-self-link href=#start-piv-agentsocket aria-label="Heading self-link"></a></h2><p>Start the agent sockets, and test:</p><pre tabindex=0><code>systemctl --user enable --now piv-agent.socket
ssh-add -l
gpg -K
</code></pre><p>This should be enough to allow you to use <code>piv-agent</code>.</p><h2 id=common-operations>Common operations<a class=td-heading-self-link href=#common-operations aria-label="Heading self-link"></a></h2><h3 id=list-keys>List keys<a class=td-heading-self-link href=#list-keys aria-label="Heading self-link"></a></h3><pre tabindex=0><code>piv-agent list
</code></pre><p>If this command returns an empty list, it may be because the running agent is holding a transaction to the hardware security device.
The solution is to stop the agent and run the list command again.</p><pre tabindex=0><code>systemctl --user stop piv-agent
# should work now..
piv-agent list
</code></pre><h2 id=advanced>Advanced<a class=td-heading-self-link href=#advanced aria-label="Heading self-link"></a></h2><p>This section describes some ways to enhance the usability of <code>piv-agent</code>.</p><h3 id=pin--passphrase-caching>PIN / Passphrase caching<a class=td-heading-self-link href=#pin--passphrase-caching aria-label="Heading self-link"></a></h3><p>If your pinentry supports caching credentials, <code>piv-agent</code> will offer to cache the PIN of the hardware security device.
It will not cache the passphrase of any fallback keys.</p><p>This is a usability/security tradeoff that ensures that at least the encrypted private key file and its passphrase aren&rsquo;t stored together on disk.
It also has the advantage of ensuring that you don&rsquo;t forget your keyfile passphrase, as you&rsquo;ll need to enter it periodically.</p><p>However you might also forget your device PIN, so maybe don&rsquo;t cache that either if you&rsquo;re concerned about that possibility.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-956da29f025cba37fca9fe6b80ab5d48>4 - FAQ</h1><h2 id=how-do-i-switch-between-gpg-agent-and-piv-agent>How do I switch between gpg-agent and piv-agent<a class=td-heading-self-link href=#how-do-i-switch-between-gpg-agent-and-piv-agent aria-label="Heading self-link"></a></h2><h3 id=linux-systemd>Linux (systemd)<a class=td-heading-self-link href=#linux-systemd aria-label="Heading self-link"></a></h3><p>Stop both <code>gpg-agent</code> and <code>piv-agent</code>:</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>The <code>pkill</code> is required because <code>gpg</code> may be configured to automatically start <code>gpg-agent</code> in a manner which is not managed by <code>systemd</code>.</div><pre tabindex=0><code>systemctl --user stop gpg-agent.socket gpg-agent.service piv-agent.socket piv-agent.service; pkill gpg-agent
</code></pre><p>Start <code>piv-agent</code> sockets:</p><pre tabindex=0><code>systemctl --user start piv-agent.socket
</code></pre><p>Or start <code>gpg-agent</code> socket:</p><pre tabindex=0><code>systemctl --user start gpg-agent.socket
</code></pre><h3 id=macos-launchd>macOS (launchd)<a class=td-heading-self-link href=#macos-launchd aria-label="Heading self-link"></a></h3><p>Stop <code>piv-agent</code>:</p><pre tabindex=0><code>launchctl disable gui/$UID/com.github.smlx.piv-agent
</code></pre><p>Start <code>piv-agent</code> sockets:</p><pre tabindex=0><code>launchctl enable gui/$UID/com.github.smlx.piv-agent
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-671ba55e5fa3b5d9ea81e2f7aab5ef61>5 - GPG Walkthrough</h1><div class=lead>Full example of how you might set up and use piv-agent with gpg.</div><h2 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h2><p>GnuPG being a complex piece of software, setup with <code>piv-agent</code> is a bit fiddly.
This example is intended to illustrate how <code>piv-agent</code> can integrate with existing GnuPG keys and workflows.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>This example requires switching between <code>gpg-agent</code> and <code>piv-agent</code>.
See the <a href=/piv-agent/docs/faq/>FAQ</a> for how to do that.</div><h2 id=setup>Setup<a class=td-heading-self-link href=#setup aria-label="Heading self-link"></a></h2><p>Suppose I have an existing RSA OpenPGP key that I use with <code>gpg</code>.
Creation of a <code>gpg</code> key is outside the scope of this document, but there are reasonable instructions <a href=https://docs.github.com/en/authentication/managing-commit-signature-verification/generating-a-new-gpg-key>here</a>.</p><p>With <code>gpg-agent</code> running, listing the RSA key looks something like this:</p><pre tabindex=0><code>$ gpg --list-secret-keys --keyid-format=long --with-keygrip
/home/scott/.gnupg/pubring.kbx
------------------------------
sec   rsa3072/EC26B2E4240DD2A9 2021-10-17 [SC]
      9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
      Keygrip = C284C191A1EA87796F4FE7159DD274A5D6CEADCC
uid                 [ultimate] Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;
ssb   rsa3072/42B99C3339C9FBC1 2021-10-17 [E]
      Keygrip = 5B918C31D4419A0D69873CB6562635C68211B872
</code></pre><p>Now we can add cryptographic subkeys stored on the Yubikey, to this RSA key, for use with <code>piv-agent</code>.</p><h3 id=export-rsa-keyfiles>Export RSA keyfiles<a class=td-heading-self-link href=#export-rsa-keyfiles aria-label="Heading self-link"></a></h3><p>Lets export the private keys of the existing RSA keypairs so that they can be used in a fallback capacity by <code>piv-agent</code>:</p><pre tabindex=0><code>umask 77; mkdir -p ~/.gnupg/piv-agent.secring
gpg --export-secret-key 0xEC26B2E4240DD2A9 &gt; ~/.gnupg/piv-agent.secring/EC26B2E4240DD2A9.gpg
</code></pre><h3 id=setup-yubikey>Setup Yubikey<a class=td-heading-self-link href=#setup-yubikey aria-label="Heading self-link"></a></h3><p>Now lets set up the Yubikey with new cryptographic keys.</p><pre tabindex=0><code># get the name of the card
$ piv-agent list
Security keys (cards):
Yubico YubiKey FIDO+CCID 01 00
...
# use the card name to setup the Yubikey
$ piv-agent setup --card=&#34;Yubico YubiKey FIDO+CCID 01 00&#34; --pin=123456 --reset-security-key
</code></pre><p>List the keys that were just generated.
This command will require entering the pin specified above, and touching the device twice.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>You might want to customize the UserID embedded in the public keys using <code>--pgp-name</code> and <code>--pgp-email</code>.
See <code>piv-agent list --help</code>.</div><pre tabindex=0><code>$ piv-agent list --key-formats=gpg
Security keys (cards):
Yubico YubiKey FIDO+CCID 01 00

Signing GPG Keys:
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Yubico YubiKey FIDO+CCID 01 00 #11577026, touch policy: always

xlIEYWvCQBMIKoZIzj0DAQcCAwSfEgRY/gnycErhFQMiij9SWlNZdkVKPPHRum8k
vnY1iE8kddErPVECabFGA22RRxaf/OJ5j9TLeGu3dTWPc2hPzUxwaXYtYWdlbnQg
KHBpdi1hZ2VudCBzaWduaW5nIGtleTsgdG91Y2gtcG9saWN5IGFsd2F5cykgPG5v
cmVwbHlAZXhhbXBsZS5jb20+wmEEExMIABMFAmFrwkAJEDSxvJa0+5T5AhsDAACh
mgD/W0BCIX0tnb2FyRfyvqpdf1245K+50UjegNrADmJkNJwA/RaELw5wd7UVNsln
/mef4Qwjp5HY6Rf6MM+uBCJ4gyT2
=CUFl
-----END PGP PUBLIC KEY BLOCK-----
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Yubico YubiKey FIDO+CCID 01 00 #11577026, touch policy: never

xlIEYWvCQBMIKoZIzj0DAQcCAwRRAjG1CSVLz55xWr7yA19Fw4uJQrRLEgCzB8f+
1EpM/gEM54VpcUZgr6+cIkRUwuU+lIOdlQhReQv9mqPWdcK5zUtwaXYtYWdlbnQg
KHBpdi1hZ2VudCBzaWduaW5nIGtleTsgdG91Y2gtcG9saWN5IG5ldmVyKSA8bm9y
ZXBseUBleGFtcGxlLmNvbT7CYQQTEwgAEwUCYWvCQAkQYerbn6tx7bECGwMAAKg3
AQDwbcR4ZklLha63wZwLYDkO4CNwRw8m8595OoabXq2g9QEAtU9MErWpO7un6GGG
tmEz6vJ2n1aPlNzxEFWkJHlq0F4=
=KYaq
-----END PGP PUBLIC KEY BLOCK-----
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Yubico YubiKey FIDO+CCID 01 00 #11577026, touch policy: cached

xlIEYWvCQBMIKoZIzj0DAQcCAwQ3pyIrqKjEdG3fqtxzJwlhsavnOzDxRsP4ttnz
Jvj20ilmWVEwuy9SRraL40KMAf//LbtsfDF7JaPIsrKTDFN2zUxwaXYtYWdlbnQg
KHBpdi1hZ2VudCBzaWduaW5nIGtleTsgdG91Y2gtcG9saWN5IGNhY2hlZCkgPG5v
cmVwbHlAZXhhbXBsZS5jb20+wmEEExMIABMFAmFrwkAJEAJzIXQG9KHGAhsDAACf
mAD+O9CAKvL52t8FNM1OrfLXBiKNibaYAb46Xk+9cHlYm90A/2OiyDBkz1fbJoEk
1Lg4AaxcNwsmPoVRMeBCXZtIndrB
=8dJl
-----END PGP PUBLIC KEY BLOCK-----

Decrypting GPG Keys:
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Yubico YubiKey FIDO+CCID 01 00 #11577026, touch policy: never

xlIEYWvCQBMIKoZIzj0DAQcCAwTHYPdFNeoy25gUFmfpi+8UYSmfWPY/YhVbwddx
ANiAQk5+nKOoAt7oucyo2IJZMgs8Rst3NLtDCDXMhPZhpBqqzU5waXYtYWdlbnQg
KHBpdi1hZ2VudCBkZWNyeXB0aW5nIGtleTsgdG91Y2gtcG9saWN5IG5ldmVyKSA8
bm9yZXBseUBleGFtcGxlLmNvbT7CYQQTEwgAEwUCYWvCQAkQFbVY84tuH9gCGwMA
ABxTAQCFK2wLxDhU5LzetlVZhTKIBi9d9h8y3/qucrZfJ/9PUQD8DG2P+S7eGSiR
blIZt6TzPLANPgND/rsiRE/Fae9VcqE=
=X7df
-----END PGP PUBLIC KEY BLOCK-----
$
</code></pre><h3 id=import-yubikey-cryptographic-keys>Import Yubikey cryptographic keys<a class=td-heading-self-link href=#import-yubikey-cryptographic-keys aria-label="Heading self-link"></a></h3><p>Import the public keys for the slots you are interested in, into <code>gpg</code>.</p><pre tabindex=0><code>gpg --import &lt;&lt;EOF
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Yubico YubiKey FIDO+CCID 01 00 #11577026, touch policy: never

xlIEYWvCQBMIKoZIzj0DAQcCAwRRAjG1CSVLz55xWr7yA19Fw4uJQrRLEgCzB8f+
1EpM/gEM54VpcUZgr6+cIkRUwuU+lIOdlQhReQv9mqPWdcK5zUtwaXYtYWdlbnQg
KHBpdi1hZ2VudCBzaWduaW5nIGtleTsgdG91Y2gtcG9saWN5IG5ldmVyKSA8bm9y
ZXBseUBleGFtcGxlLmNvbT7CYQQTEwgAEwUCYWvCQAkQYerbn6tx7bECGwMAAKg3
AQDwbcR4ZklLha63wZwLYDkO4CNwRw8m8595OoabXq2g9QEAtU9MErWpO7un6GGG
tmEz6vJ2n1aPlNzxEFWkJHlq0F4=
=KYaq
-----END PGP PUBLIC KEY BLOCK-----
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Yubico YubiKey FIDO+CCID 01 00 #11577026, touch policy: never

xlIEYWvCQBMIKoZIzj0DAQcCAwTHYPdFNeoy25gUFmfpi+8UYSmfWPY/YhVbwddx
ANiAQk5+nKOoAt7oucyo2IJZMgs8Rst3NLtDCDXMhPZhpBqqzU5waXYtYWdlbnQg
KHBpdi1hZ2VudCBkZWNyeXB0aW5nIGtleTsgdG91Y2gtcG9saWN5IG5ldmVyKSA8
bm9yZXBseUBleGFtcGxlLmNvbT7CYQQTEwgAEwUCYWvCQAkQFbVY84tuH9gCGwMA
ABxTAQCFK2wLxDhU5LzetlVZhTKIBi9d9h8y3/qucrZfJ/9PUQD8DG2P+S7eGSiR
blIZt6TzPLANPgND/rsiRE/Fae9VcqE=
=X7df
-----END PGP PUBLIC KEY BLOCK-----
EOF
gpg: key 61EADB9FAB71EDB1: public key &#34;piv-agent (piv-agent signing key; touch-policy never) &lt;noreply@example.com&gt;&#34; imported
gpg: key 15B558F38B6E1FD8: public key &#34;piv-agent (piv-agent decrypting key; touch-policy never) &lt;noreply@example.com&gt;&#34; imported
gpg: Total number processed: 2
gpg:               imported: 2
</code></pre><p>Listing the public keys known to <code>gpg</code> now shows the new keys.</p><pre tabindex=0><code>$ gpg --list-keys --keyid-format=long --with-keygrip
/home/scott/.gnupg/pubring.kbx
------------------------------
pub   rsa3072/EC26B2E4240DD2A9 2021-10-17 [SC]
      9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
      Keygrip = C284C191A1EA87796F4FE7159DD274A5D6CEADCC
uid                 [ultimate] Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;
sub   rsa3072/42B99C3339C9FBC1 2021-10-17 [E]
      Keygrip = 5B918C31D4419A0D69873CB6562635C68211B872

pub   nistp256/61EADB9FAB71EDB1 2021-10-17 [SC]
      C0DDA160CE064B915F85611C61EADB9FAB71EDB1
      Keygrip = 635FB47CEDA6B1C52F6E13AC5CC83629CB740CA1
uid                 [ unknown] piv-agent (piv-agent signing key; touch-policy never) &lt;noreply@example.com&gt;

pub   nistp256/15B558F38B6E1FD8 2021-10-17 [SC]
      4AB8F06DBC18A54D056D15F315B558F38B6E1FD8
      Keygrip = 2925C2C0CAA1752F6F162BD68786EF020CF464F8
uid                 [ unknown] piv-agent (piv-agent decrypting key; touch-policy never) &lt;noreply@example.com&gt;
</code></pre><p>But no secret keys yet.</p><pre tabindex=0><code>$ gpg --list-secret-keys --keyid-format=long --with-keygrip
/home/scott/.gnupg/pubring.kbx
------------------------------
sec   rsa3072/EC26B2E4240DD2A9 2021-10-17 [SC]
      9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
      Keygrip = C284C191A1EA87796F4FE7159DD274A5D6CEADCC
uid                 [ultimate] Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;
ssb   rsa3072/42B99C3339C9FBC1 2021-10-17 [E]
      Keygrip = 5B918C31D4419A0D69873CB6562635C68211B872
</code></pre><p>Stop <code>gpg-agent</code>, start <code>piv-agent</code>, and list secret keys again.
Now the cryptographic keys stored on the Yubikey are available.</p><pre tabindex=0><code>$ gpg --list-secret-keys --keyid-format=long --with-keygrip
/home/scott/.gnupg/pubring.kbx
------------------------------
sec   rsa3072/EC26B2E4240DD2A9 2021-10-17 [SC]
      9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
      Keygrip = C284C191A1EA87796F4FE7159DD274A5D6CEADCC
uid                 [ultimate] Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;
ssb   rsa3072/42B99C3339C9FBC1 2021-10-17 [E]
      Keygrip = 5B918C31D4419A0D69873CB6562635C68211B872

sec   nistp256/61EADB9FAB71EDB1 2021-10-17 [SC]
      C0DDA160CE064B915F85611C61EADB9FAB71EDB1
      Keygrip = 635FB47CEDA6B1C52F6E13AC5CC83629CB740CA1
uid                 [ unknown] piv-agent (piv-agent signing key; touch-policy never) &lt;noreply@example.com&gt;

sec   nistp256/15B558F38B6E1FD8 2021-10-17 [SC]
      4AB8F06DBC18A54D056D15F315B558F38B6E1FD8
      Keygrip = 2925C2C0CAA1752F6F162BD68786EF020CF464F8
uid                 [ unknown] piv-agent (piv-agent decrypting key; touch-policy never) &lt;noreply@example.com&gt;
</code></pre><h3 id=add-decrypting-subkey>Add decrypting subkey<a class=td-heading-self-link href=#add-decrypting-subkey aria-label="Heading self-link"></a></h3><p>Now we can add the piv-agent decrypting key as a subkey of the RSA master key.</p><pre tabindex=0><code>$ gpg --expert --edit-key 0xEC26B2E4240DD2A9
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

sec  rsa3072/EC26B2E4240DD2A9
     created: 2021-10-17  expires: never       usage: SC  
     trust: ultimate      validity: ultimate
ssb  rsa3072/42B99C3339C9FBC1
     created: 2021-10-17  expires: never       usage: E   
[ultimate] (1). Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;

gpg&gt; addkey
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
  (14) Existing key from card
Your selection? 13
Enter the keygrip: 2925C2C0CAA1752F6F162BD68786EF020CF464F8

Possible actions for a ECDH key: Encrypt 
Current allowed actions: Encrypt 

   (E) Toggle the encrypt capability
   (Q) Finished

Your selection? q
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 
Key does not expire at all
Is this correct? (y/N) y
Really create? (y/N) y

sec  rsa3072/EC26B2E4240DD2A9
     created: 2021-10-17  expires: never       usage: SC  
     trust: ultimate      validity: ultimate
ssb  rsa3072/42B99C3339C9FBC1
     created: 2021-10-17  expires: never       usage: E   
ssb  nistp256/84F7BF2FEAC32674
     created: 2021-10-17  expires: never       usage: E   
[ultimate] (1). Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;

gpg&gt; save
</code></pre><h3 id=add-signing-subkey>Add signing subkey<a class=td-heading-self-link href=#add-signing-subkey aria-label="Heading self-link"></a></h3><p>And we can add the piv-agent signing key as a subkey of the RSA master key too.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>This doesn&rsquo;t currently work without a patch in GnuPG due to <a href=https://dev.gnupg.org/T5555>this GnuPG bug</a>.</p><p>Until this is fixed upstream, <a href=https://github.com/smlx/gnupg-piv-agent>here is a Docker image</a> containing a patched version of <code>gpg</code> which will add ECDSA keys as signing subkeys.</p><p>The example session below is with a patched version of <code>gpg</code>.</p></div><pre tabindex=0><code>$ gpg --expert --edit-key 0xEC26B2E4240DD2A9
gpg (GnuPG) 2.3.2; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

sec  rsa3072/EC26B2E4240DD2A9
     created: 2021-10-17  expires: never       usage: SC  
     trust: ultimate      validity: ultimate
ssb  rsa3072/42B99C3339C9FBC1
     created: 2021-10-17  expires: never       usage: E   
ssb  nistp256/84F7BF2FEAC32674
     created: 2021-10-17  expires: never       usage: E   
[ultimate] (1). Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;

gpg&gt; addkey
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
  (14) Existing key from card
Your selection? 13
Enter the keygrip: 635FB47CEDA6B1C52F6E13AC5CC83629CB740CA1

Possible actions for this ECC key: Sign Authenticate 
Current allowed actions: Sign 

   (S) Toggle the sign capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? q
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 
Key does not expire at all
Is this correct? (y/N) y
Really create? (y/N) y

sec  rsa3072/EC26B2E4240DD2A9
     created: 2021-10-17  expires: never       usage: SC  
     trust: ultimate      validity: ultimate
ssb  rsa3072/42B99C3339C9FBC1
     created: 2021-10-17  expires: never       usage: E   
ssb  nistp256/84F7BF2FEAC32674
     created: 2021-10-17  expires: never       usage: E   
ssb  nistp256/3F086B69FEE7985B
     created: 2021-10-17  expires: never       usage: S   
[ultimate] (1). Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;

gpg&gt; save
</code></pre><h3 id=inspect-subkeys>Inspect subkeys<a class=td-heading-self-link href=#inspect-subkeys aria-label="Heading self-link"></a></h3><p>The cryptographic keys stored on the Yubikey are now subkeys of the RSA master key.</p><pre tabindex=0><code>$ gpg --list-secret-keys --keyid-format=long --with-keygrip
/home/scott/.gnupg/pubring.kbx
------------------------------
sec   rsa3072/EC26B2E4240DD2A9 2021-10-17 [SC]
      9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
      Keygrip = C284C191A1EA87796F4FE7159DD274A5D6CEADCC
uid                 [ultimate] Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;
ssb   rsa3072/42B99C3339C9FBC1 2021-10-17 [E]
      Keygrip = 5B918C31D4419A0D69873CB6562635C68211B872
ssb   nistp256/84F7BF2FEAC32674 2021-10-17 [E]
      Keygrip = 2925C2C0CAA1752F6F162BD68786EF020CF464F8
ssb   nistp256/3F086B69FEE7985B 2021-10-17 [S]
      Keygrip = 635FB47CEDA6B1C52F6E13AC5CC83629CB740CA1

sec   nistp256/61EADB9FAB71EDB1 2021-10-17 [SC]
      C0DDA160CE064B915F85611C61EADB9FAB71EDB1
      Keygrip = 635FB47CEDA6B1C52F6E13AC5CC83629CB740CA1
uid                 [ unknown] piv-agent (piv-agent signing key; touch-policy never) &lt;noreply@example.com&gt;

sec   nistp256/15B558F38B6E1FD8 2021-10-17 [SC]
      4AB8F06DBC18A54D056D15F315B558F38B6E1FD8
      Keygrip = 2925C2C0CAA1752F6F162BD68786EF020CF464F8
uid                 [ unknown] piv-agent (piv-agent decrypting key; touch-policy never) &lt;noreply@example.com&gt;
</code></pre><h2 id=use>Use<a class=td-heading-self-link href=#use aria-label="Heading self-link"></a></h2><p>Signing and encryption using the RSA master key ID will now preferentially use the cryptographic keys stored on the Yubikey, falling back to the keyfiles if the Yubikey is not available.
Specify the master key ID (e.g. <code>0x9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9</code> or <code>0xEC26B2E4240DD2A9</code>) to use the subkeys.
The subkey with the most recent date is preferred by <code>gpg</code>.</p><p>Importantly the master key ID is the same after adding the subkeys, so any existing workflows will continue to work as before.</p><h3 id=publish-public-key>Publish public key<a class=td-heading-self-link href=#publish-public-key aria-label="Heading self-link"></a></h3><p>The public key can now be distributed to keyservers and other services such as Github.
The subkeys are included in the exported master public key.</p><pre tabindex=0><code>$ gpg --export --armor 0xEC26B2E4240DD2A9
-----BEGIN PGP PUBLIC KEY BLOCK-----

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
FZbaoApovI7Dy6J1Ewo0vTA=
=hNHV
-----END PGP PUBLIC KEY BLOCK-----
</code></pre><h3 id=signing-example>Signing Example<a class=td-heading-self-link href=#signing-example aria-label="Heading self-link"></a></h3><p>With the Yubikey plugged in, the cryptographic key stored in hardware is used for signing.</p><pre tabindex=0><code>$ echo bar &gt; foo; gpg --output foo.sig --local-user 0xEC26B2E4240DD2A9 --sign foo
$ gpg --verify -v ./foo.sig
gpg: original file name=&#39;foo&#39;
gpg: Signature made Sun 17 Oct 2021 15:48:16 AWST
gpg:                using ECDSA key 28D1AAA597866ABB0B5AFC553F086B69FEE7985B
gpg: using subkey 3F086B69FEE7985B instead of primary key EC26B2E4240DD2A9
gpg: using subkey 3F086B69FEE7985B instead of primary key EC26B2E4240DD2A9
gpg: using pgp trust model
gpg: Good signature from &#34;Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;&#34; [ultimate]
gpg: using subkey 3F086B69FEE7985B instead of primary key EC26B2E4240DD2A9
gpg: binary signature, digest algorithm SHA256, key algorithm nistp256
gpg: WARNING: not a detached signature; file &#39;./foo&#39; was NOT verified!
</code></pre><p>With the Yubikey unplugged, the traditional keyfile is used for signing.</p><pre tabindex=0><code>$ gpg --verify -v ./foo.sig
gpg: original file name=&#39;foo&#39;
gpg: Signature made Sun 17 Oct 2021 16:16:32 AWST
gpg:                using RSA key 9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
gpg: using pgp trust model
gpg: Good signature from &#34;Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;&#34; [ultimate]
gpg: binary signature, digest algorithm SHA512, key algorithm rsa3072
gpg: WARNING: not a detached signature; file &#39;./foo&#39; was NOT verified!
</code></pre><h3 id=decrypting-example>Decrypting Example<a class=td-heading-self-link href=#decrypting-example aria-label="Heading self-link"></a></h3><p>Encryption also prefers the cryptographic key stored in hardware.</p><pre tabindex=0><code>$ echo bar &gt; foo; gpg --output foo.enc --recipient 0xEC26B2E4240DD2A9 --encrypt foo
$ gpg --decrypt -v ./foo.enc
gpg: public key is 84F7BF2FEAC32674
gpg: using subkey 84F7BF2FEAC32674 instead of primary key EC26B2E4240DD2A9
gpg: using subkey 84F7BF2FEAC32674 instead of primary key EC26B2E4240DD2A9
gpg: encrypted with 256-bit ECDH key, ID 84F7BF2FEAC32674, created 2021-10-17
      &#34;Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;&#34;
gpg: AES256 encrypted data
gpg: original file name=&#39;foo&#39;
bar
</code></pre><p>You can also specify multiple key IDs when encrypting (one keyfile, one hardware), for fallback purposes.</p><pre tabindex=0><code>$ echo bar &gt; foo; gpg --output foo.enc --recipient 0x42B99C3339C9FBC1! --recipient 0x84F7BF2FEAC32674! --encrypt foo
$ gpg --decrypt -v ./foo.enc
gpg: public key is 42B99C3339C9FBC1
gpg: using subkey 42B99C3339C9FBC1 instead of primary key EC26B2E4240DD2A9
gpg: public key is 84F7BF2FEAC32674
gpg: using subkey 84F7BF2FEAC32674 instead of primary key EC26B2E4240DD2A9
gpg: encrypted with 256-bit ECDH key, ID 84F7BF2FEAC32674, created 2021-10-17
      &#34;Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;&#34;
gpg: using subkey 42B99C3339C9FBC1 instead of primary key EC26B2E4240DD2A9
gpg: encrypted with 3072-bit RSA key, ID 42B99C3339C9FBC1, created 2021-10-17
      &#34;Scott Leggett (piv-agent documentation example) &lt;scott@sl.id.au&gt;&#34;
gpg: AES256 encrypted data
gpg: original file name=&#39;foo&#39;
bar
</code></pre><h3 id=common-software-integration>Common software integration<a class=td-heading-self-link href=#common-software-integration aria-label="Heading self-link"></a></h3><h4 id=git>git<a class=td-heading-self-link href=#git aria-label="Heading self-link"></a></h4><p>The same master key ID will work as before, but signing will prefer to use the hardware security device if it is plugged in.</p><pre tabindex=0><code># example ~/.config/git/config
[user]
	name = Scott Leggett
	email = scott@sl.id.au
	signingKey = 9FA216008BDF1AE5E1BCAEC3EC26B2E4240DD2A9
[commit]
	gpgSign = true
</code></pre><h4 id=pass>pass<a class=td-heading-self-link href=#pass aria-label="Heading self-link"></a></h4><p><code>pass</code> has the ability to encrypt to multiple key-ids.
Running <code>pass init</code> will re-encrypt existing passwords and configure <code>pass</code> to use the specified key-ids for encryption.
As usual, <code>piv-agent</code> will use the cryptographic key stored in hardware for decryption if it is available, but fall back to the keyfile otherwise.</p><pre tabindex=0><code>pass init 0x42B99C3339C9FBC1! 0x84F7BF2FEAC32674!
</code></pre></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/smlx/piv-agent aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2020&ndash;2024
<span class=td-footer__authors>PIV Agent Contributors | <a href=https://creativecommons.org/licenses/by-sa/4.0>CC BY SA 4.0</a></span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/piv-agent/js/main.min.248655eb216150e39da254c2f7aa5357805d0ec66bdb741b591cd35fb5f629ab.js integrity="sha256-JIZV6yFhUOOdolTC96pTV4BdDsZr23QbWRzTX7X2Kas=" crossorigin=anonymous></script><script defer src=/piv-agent/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script><script src=/piv-agent/js/tabpane-persist.js></script></body></html>